/**************************************************************************

  =======================
  The Voyager Web Browser
  =======================

  Copyright (C) 1995-2003 by
   Oliver Wagner <owagner@vapor.com>
   All Rights Reserved

  Parts Copyright (C) by
   David Gerber <zapek@vapor.com>
   Jon Bright <jon@siliconcircus.com>
   Matt Sealey <neko@vapor.com>

**************************************************************************/


#include "voyager.h"

/* public */
#if defined( AMIGAOS ) || defined( __MORPHOS__ )
#include <proto/exec.h>
#include <datatypes/pictureclass.h>
#endif

/* private */
#include "voyager_cat.h"
#include "copyright.h"
#include "prefs.h"
#include "classes.h"
#include "time_func.h"
#include "malloc.h"
#include "mui_func.h"
#include "htmlclasses.h"


const ULONG __far reglogo_colors[96] =
{
	0x46464646,0x1d1d1d1d,0x20202020,
	0x4e4e4e4e,0x27272727,0x41414141,
	0x55555555,0x46464646,0x51515151,
	0x6f6f6f6f,0x5b5b5b5b,0x5b5b5b5b,
	0x87878787,0x23232323,0x25252525,
	0x85858585,0x4c4c4c4c,0x4a4a4a4a,
	0xbbbbbbbb,0x22222222,0x25252525,
	0xb8b8b8b8,0x46464646,0x47474747,
	0x4f4f4f4f,0x4b4b4b4b,0x7f7f7f7f,
	0x8b8b8b8b,0x7f7f7f7f,0x7c7c7c7c,
	0x3c3c3c3c,0x37373737,0xbabababa,
	0x71717171,0x6d6d6d6d,0xd7d7d7d7,
	0x9c9c9c9c,0x87878787,0x88888888,
	0xbdbdbdbd,0x85858585,0x86868686,
	0xbbbbbbbb,0x9f9f9f9f,0xadadadad,
	0xc2c2c2c2,0xb6b6b6b6,0xb9b9b9b9,
	0xd0d0d0d0,0xcdcdcdcd,0xc8c8c8c8,
	0xdfdfdfdf,0xcfcfcfcf,0xcbcbcbcb,
	0xd2d2d2d2,0xd1d1d1d1,0xdfdfdfdf,
	0xe4e4e4e4,0xe0e0e0e0,0xdddddddd,
	0xefefefef,0xe8e8e8e8,0xe3e3e3e3,
	0xfafafafa,0xe9e9e9e9,0xe5e5e5e5,
	0xf0f0f0f0,0xf3f3f3f3,0xedededed,
	0xfdfdfdfd,0xf9f9f9f9,0xefefefef,
	0xe3e3e3e3,0xe4e4e4e4,0xf7f7f7f7,
	0xefefefef,0xf2f2f2f2,0xfbfbfbfb,
	0xf7f7f7f7,0xf7f7f7f7,0xf7f7f7f7,
	0xfbfbfbfb,0xf7f7f7f7,0xfbfbfbfb,
	0xf7f7f7f7,0xffffffff,0xfbfbfbfb,
	0xffffffff,0xf7f7f7f7,0xffffffff,
	0xffffffff,0xffffffff,0xf7f7f7f7,
	0xffffffff,0xffffffff,0xffffffff,
};

const struct BitMapHeader __far reglogo_header =
{ 64,43,0,0,5,2,1,0,0,44,44,320,200 };


const UBYTE __far reglogo_body[1755] = {
0xff,0xff,0x05,0xfc,0xa8,0x2f,0x7f,0xff,0xff,0x07,0xff,0x80,0x03,0xfb,0x9c,
0x80,0x00,0xff,0xfe,0xff,0x01,0x00,0x0f,0xfe,0xff,0xfe,0xff,0x01,0xfc,0x73,
0xfe,0xff,0xf9,0xff,0xff,0xff,0x02,0xfb,0x4c,0x1b,0xfe,0xff,0x07,0xff,0x80,
0x04,0xef,0xd7,0x00,0x00,0xff,0xfe,0xff,0x01,0x48,0x12,0xfe,0xff,0xfe,0xff,
0x01,0xbf,0xfd,0xfe,0xff,0xfe,0xff,0x01,0xf0,0x0f,0xfe,0xff,0xfe,0xff,0x01,
0x1f,0x0f,0xfe,0xff,0x07,0xff,0x80,0x04,0xdf,0xfb,0x00,0x00,0xff,0xfe,0xff,
0x01,0x00,0x03,0xfe,0xff,0xff,0xff,0x02,0xfb,0xff,0xfc,0xfe,0xff,0xfe,0xff,
0x01,0xe0,0x07,0xfe,0xff,0xff,0xff,0x02,0xfb,0xff,0x84,0xfe,0xff,0x07,0xff,
0x00,0x07,0xbf,0xf7,0x00,0x00,0xff,0xff,0xff,0x02,0xfc,0x80,0x01,0xfe,0xff,
0xfe,0xff,0x00,0x7f,0xfd,0xff,0xfe,0xff,0x01,0xc0,0x03,0xfe,0xff,0xfe,0xff,
0x01,0x7f,0x81,0xfe,0xff,0x07,0xff,0x00,0x03,0xff,0xfb,0x80,0x00,0xff,0xff,
0xff,0x02,0xfd,0x40,0x00,0xfe,0xff,0xff,0xff,0x05,0xfe,0xff,0xfd,0x7f,0xff,
0xff,0xfe,0xff,0x01,0x80,0x03,0xfe,0xff,0xfd,0xff,0x00,0x83,0xfe,0xff,0x07,
0xff,0x00,0x0b,0x7f,0xf9,0xc0,0x00,0xff,0xff,0xff,0x05,0xf5,0x00,0x00,0xbf,
0xff,0xff,0xff,0xff,0x05,0xfe,0xff,0xff,0x7f,0xff,0xff,0xfe,0xff,0x01,0x80,
0x01,0xfe,0xff,0xfe,0xff,0x01,0x3f,0x81,0xfe,0xff,0x07,0xff,0x0c,0x0d,0xff,
0xf0,0xc0,0x00,0xff,0x07,0xff,0xf3,0xfb,0x00,0x00,0xbf,0xff,0xff,0xff,0xff,
0x05,0xf6,0x7f,0xff,0x7f,0xff,0xff,0xfe,0xff,0x01,0x80,0x01,0xfe,0xff,0x07,
0xff,0xf3,0xec,0x1f,0x81,0xf0,0x09,0xff,0x07,0xfe,0x80,0x01,0xff,0xf1,0x00,
0x06,0xff,0x07,0xff,0x5f,0xff,0x00,0x00,0xff,0xf5,0xff,0x07,0xff,0xe0,0x00,
0x7f,0xfe,0x00,0x03,0xff,0xfe,0xff,0x01,0x80,0x01,0xfe,0xff,0x07,0xff,0x0f,
0xfe,0x8f,0x00,0x7f,0x7b,0xff,0x07,0xff,0xc0,0x01,0xff,0xf0,0x80,0x1e,0xff,
0x07,0xff,0xbf,0xff,0x80,0x00,0xff,0x85,0xff,0x07,0xff,0xdf,0xff,0xff,0xfe,
0xff,0xe3,0xff,0x07,0xff,0xe0,0x00,0x00,0x01,0x00,0x07,0xff,0x07,0xff,0xb0,
0x03,0x00,0x01,0xc0,0x27,0xff,0x07,0xff,0xf3,0xf8,0xff,0xe1,0xf8,0x06,0xff,
0xfe,0xff,0x04,0x80,0x01,0xff,0xc1,0xff,0x07,0xff,0x10,0x01,0xff,0xff,0x00,
0x07,0xff,0x01,0xff,0xe0,0xfd,0x00,0x01,0x0f,0xff,0x07,0xfe,0xd0,0x01,0x00,
0x06,0x80,0x07,0xff,0x07,0xfe,0x73,0xf9,0xbf,0xc1,0xf8,0x0c,0xff,0x07,0xff,
0x9f,0xff,0x80,0x01,0xff,0xd3,0xff,0x07,0xff,0xe8,0x00,0xff,0xfb,0x00,0x1f,
0xff,0x01,0xff,0xf0,0xfd,0x00,0x01,0x0f,0xff,0x07,0xfe,0xf4,0x01,0x00,0x0d,
0x80,0x27,0xff,0x07,0xfe,0x31,0xf0,0x5f,0x82,0xfe,0x3e,0xff,0x07,0xff,0xcf,
0xff,0xc0,0x03,0xff,0xd1,0xff,0x07,0xff,0xf0,0x00,0xff,0xf3,0x00,0x0f,0xff,
0x01,0xff,0xf8,0xfd,0x00,0x01,0x1f,0xff,0x07,0xff,0x3c,0x01,0x80,0x2b,0x80,
0x7d,0xff,0x07,0xfe,0xf8,0xe0,0xc2,0x01,0xef,0x39,0xff,0x07,0xff,0x83,0xff,
0x40,0x07,0xff,0x87,0xff,0x07,0xff,0xf8,0x00,0x7f,0xd6,0x00,0x1f,0xff,0x01,
0xff,0xfc,0xfd,0x00,0x01,0x3f,0xff,0x07,0xff,0x1e,0x00,0xd0,0x63,0x00,0x5f,
0xff,0x07,0xfd,0xfc,0x00,0x20,0x15,0xff,0x76,0xff,0x07,0xfe,0xcf,0xff,0xa0,
0x0f,0xff,0x49,0xff,0x07,0xff,0xb2,0x00,0x7f,0x8e,0x00,0x7f,0xff,0x01,0xff,
0xfc,0xfd,0x00,0x01,0x3f,0xff,0x07,0xff,0xcf,0x01,0xe1,0xa6,0x00,0xff,0xff,
0x07,0xfe,0xfd,0x00,0x58,0x5b,0xfe,0x70,0xff,0x07,0xff,0x82,0xfe,0x18,0x1f,
0xff,0x4f,0xff,0x07,0xff,0xfc,0x00,0x3e,0x3c,0x00,0xbf,0xff,0x01,0xff,0xfe,
0xfd,0x00,0x01,0x7f,0xff,0x07,0xff,0xc1,0x81,0xf3,0xdc,0x01,0x7f,0xff,0x07,
0xff,0x66,0x00,0x17,0xef,0xfc,0x60,0xff,0x07,0xff,0x9c,0xfe,0x2f,0xff,0xff,
0x9f,0xff,0x07,0xff,0xe2,0x00,0x0f,0xf0,0x00,0x7f,0xff,0xff,0xff,0xfd,0x00,
0xff,0xff,0x07,0xff,0x81,0x4e,0x7f,0xf8,0x01,0x4f,0xff,0x07,0xff,0x46,0x00,
0x02,0x7f,0xfc,0xe0,0xff,0x07,0xff,0x9a,0x80,0x1f,0xff,0xfe,0x1f,0xff,0x07,
0xff,0xd8,0xc0,0x01,0x80,0x00,0xff,0xff,0x01,0xff,0xe7,0xfe,0x00,0x02,0x01,
0xff,0xff,0x07,0xff,0x98,0x88,0x23,0xe0,0x02,0xb3,0xff,0x07,0xff,0x4e,0x40,
0x00,0x0f,0xf9,0xcf,0xff,0x07,0xff,0x85,0x00,0x1f,0xff,0xff,0x01,0xff,0x07,
0xff,0xd5,0x80,0x00,0x00,0x02,0xff,0xff,0x01,0xff,0xe2,0xfe,0x00,0x02,0x01,
0xff,0xff,0x07,0xff,0x9f,0xf7,0x27,0x75,0xf8,0xdd,0xff,0x07,0xff,0x4b,0xe1,
0x40,0x02,0x32,0xfe,0xff,0x07,0xff,0x82,0x08,0x99,0xbf,0xfe,0x3f,0xff,0x07,
0xff,0xd6,0x1c,0x9b,0xe7,0xce,0x3d,0xff,0x01,0xff,0xe0,0xfe,0x00,0x02,0x01,
0xc3,0xff,0x07,0xff,0xd7,0x3a,0x6c,0x82,0xf6,0x39,0xff,0x07,0xfe,0x6d,0x83,
0xec,0x73,0x08,0xc4,0x7f,0x07,0xff,0x80,0x44,0x93,0x6b,0x39,0xc7,0xff,0x07,
0xff,0xd2,0x7c,0x93,0xeb,0x1f,0xfd,0xff,0x07,0xff,0xe0,0x00,0x00,0x04,0xc0,
0x03,0xff,0x07,0xff,0xc4,0xa4,0x45,0x17,0xd1,0xad,0xff,0x07,0xfe,0x5f,0x90,
0x00,0x2c,0xf8,0x36,0x7f,0x07,0xff,0xb0,0x42,0xb2,0x6c,0xde,0x47,0xff,0x07,
0xff,0xd0,0x66,0xf6,0x6c,0xdf,0xcd,0xff,0x01,0xff,0xe0,0xfd,0x00,0x01,0x03,
0xff,0x07,0xff,0xd0,0x10,0x91,0x85,0xf7,0xf9,0xff,0x07,0xff,0x3f,0x08,0x12,
0x6c,0xd7,0xba,0xff,0x07,0xff,0xf0,0xe6,0x66,0x6d,0xd8,0x0d,0xff,0x07,0xff,
0xd0,0xf6,0xe6,0x6c,0xd8,0x4b,0xff,0x01,0xff,0xe0,0xfd,0x00,0x01,0x07,0xff,
0x07,0xff,0xc9,0x82,0xa6,0x04,0x87,0x4b,0xff,0x07,0xff,0x2e,0xbe,0x83,0xc0,
0x10,0xed,0xff,0x07,0xff,0xc0,0xfc,0x43,0xe8,0x58,0x93,0xff,0x07,0xff,0xe1,
0xfc,0x67,0xe8,0x5f,0x97,0xff,0x07,0xff,0xf0,0x00,0x00,0x07,0x80,0x0f,0xff,
0x07,0xff,0xd7,0xc4,0x84,0xf9,0x6f,0xc7,0xff,0x07,0xff,0x37,0xc0,0xa0,0xa0,
0x02,0xf3,0x7f,0x07,0xff,0xc9,0x78,0x43,0x0e,0x10,0x9d,0xff,0x07,0xff,0xe9,
0x7c,0x43,0x47,0x7d,0x97,0xff,0x07,0xff,0xf0,0x80,0x00,0x00,0x80,0x0f,0xff,
0x07,0xff,0xe7,0x47,0x00,0x13,0xc8,0x27,0xff,0x07,0xff,0x17,0xd6,0x00,0x0d,
0x9e,0xbc,0xff,0x07,0xff,0xf6,0x9c,0xcc,0x3d,0x8e,0x27,0xff,0x07,0xff,0xe6,
0x1c,0xc0,0x0f,0xce,0x2f,0xff,0x07,0xff,0xf9,0xe0,0x00,0x00,0x31,0xdf,0xff,
0x07,0xff,0xf0,0xdb,0x00,0x08,0xa2,0x0f,0xff,0x07,0xff,0x0f,0x7a,0x40,0x00,
0xfb,0xf0,0xff,0x07,0xff,0xf6,0xa4,0x8f,0xff,0x4d,0xef,0xff,0x07,0xff,0xf9,
0xc1,0x80,0x07,0x50,0x1f,0xff,0xff,0xff,0x05,0xfe,0x00,0x00,0x3f,0xff,0xff,
0xff,0xff,0x05,0xf9,0x00,0x00,0x5f,0xff,0xff,0x07,0xff,0x06,0x3f,0x00,0x00,
0xfa,0x88,0xff,0xff,0xff,0x05,0xe3,0x1f,0xf8,0x85,0xff,0xff,0xff,0xff,0x05,
0xfd,0x00,0x00,0xbf,0xff,0xff,0xff,0xff,0x05,0xfe,0x00,0x00,0x7f,0xff,0xff,
0xff,0xff,0x05,0xf8,0x00,0x00,0x3f,0xff,0xff,0x07,0xff,0x00,0x0f,0x00,0x00,
0x60,0x00,0xff,0xff,0xff,0x05,0xf1,0xbf,0xfd,0x9f,0xff,0xff,0xff,0xff,0x05,
0xfe,0x80,0x01,0x7f,0xff,0xff,0xfe,0xff,0xff,0x00,0xfe,0xff,0xff,0xff,0x05,
0xfe,0xf8,0xfe,0x7f,0xff,0xff,0x07,0xff,0x00,0x0f,0x00,0x01,0x80,0x00,0xff,
0xff,0xff,0x05,0xf0,0xbf,0xfd,0x7f,0xff,0xff,0xfe,0xff,0x01,0x40,0x02,0xfe,
0xff,0xfe,0xff,0x01,0x80,0x01,0xfe,0xff,0xff,0xff,0x05,0xf8,0x09,0xca,0x7f,
0xff,0xff,0x07,0xff,0x00,0x01,0xb0,0x02,0x80,0x00,0xff,0xff,0xff,0x01,0xfe,
0xb7,0xfd,0xff,0xfe,0xff,0x04,0x38,0xfe,0x7f,0xff,0xff,0xfe,0xff,0x01,0xc0,
0x01,0xfe,0xff,0xfe,0xff,0x04,0x46,0xee,0x3f,0xff,0xff,0x07,0xff,0x00,0x0b,
0xc1,0x2e,0x40,0x00,0xff,0xff,0xff,0x05,0xfd,0xff,0x11,0xbf,0xff,0xff,0xff,
0xff,0x05,0xfe,0x79,0xd1,0x7f,0xff,0xff,0xfe,0xff,0x01,0x80,0x00,0xfe,0xff,
0xfe,0xff,0x04,0x36,0xdb,0xbf,0xff,0xff,0x07,0xff,0x00,0x01,0x81,0xc3,0x40,
0x00,0xff,0xfe,0xff,0x04,0x89,0x20,0x7f,0xff,0xff,0xff,0xff,0x05,0xfe,0x3f,
0x38,0x3f,0xff,0xff,0xfe,0xff,0x01,0xc0,0x04,0xfe,0xff,0xfe,0xff,0x04,0x7d,
0xf2,0xbf,0xff,0xff,0x07,0xff,0x00,0x01,0xc2,0xc2,0x40,0x00,0xff,0xfe,0xff,
0x04,0x86,0x05,0x3f,0xff,0xff,0xff,0xff,0x05,0xfe,0x3f,0x35,0x7f,0xff,0xff,
0xfe,0xff,0x01,0xc0,0x08,0xfe,0xff,0xff,0xff,0x05,0xfe,0xd9,0xf7,0xbf,0xff,
0xff,0x07,0xff,0x00,0x09,0xe3,0x83,0xc0,0x00,0xff,0xff,0xff,0x05,0xf6,0xa2,
0x01,0x3f,0xff,0xff,0xfe,0xff,0x04,0x3a,0x65,0x7f,0xff,0xff,0xfe,0xff,0x01,
0xc4,0x18,0xfe,0xff,0xff,0xff,0x02,0xf3,0xbf,0xdb,0xfe,0xff,0x07,0xff,0x00,
0x0f,0xaf,0xaa,0xc0,0x00,0xff,0xff,0xff,0x05,0xfe,0xe4,0x28,0x3f,0xff,0xff,
0xfe,0xff,0x04,0x34,0x79,0x7f,0xff,0xff,0xfe,0xff,0x01,0xc0,0x04,0xfe,0xff,
0xfe,0xff,0x01,0xbf,0x9e,0xfe,0xff,0x07,0xff,0x00,0x0c,0x8b,0x02,0xc0,0x00,
0xff,0xff,0xff,0x05,0xf3,0xc0,0x41,0x3f,0xff,0xff,0xfe,0xff,0x04,0x14,0xdd,
0x7f,0xff,0xff,0xfe,0xff,0x01,0xe0,0x20,0xfe,0xff,0xfe,0xff,0x04,0x7f,0xbc,
0x7f,0xff,0xff,0x07,0xff,0x00,0x04,0xef,0x30,0x40,0x00,0xff,0xff,0xff,0x05,
0xfb,0xc0,0x12,0xbf,0xff,0xff,0xfe,0xff,0x04,0x90,0x9e,0x7f,0xff,0xff,0xfe,
0xff,0x01,0xe0,0x61,0xfe,0xff,0xfe,0xff,0x04,0xce,0x9a,0x5f,0xff,0xff,0x07,
0xff,0x00,0x00,0xce,0xf0,0xf0,0x00,0xff,0xfe,0xff,0x04,0xf1,0xe1,0x9f,0xff,
0xff,0xfe,0xff,0x04,0x11,0x80,0x7f,0xff,0xff,0xfe,0xff,0x01,0xe0,0x7f,0xfe,
0xff,0xfe,0xff,0x04,0xdf,0x70,0x7f,0xff,0xff,0x07,0xff,0x00,0x00,0xdd,0x7f,
0x80,0x00,0xff,0xfe,0xff,0x01,0x71,0xfe,0xfe,0xff,0xfe,0xff,0x01,0x93,0x01,
0xfe,0xff,0xfe,0xff,0x00,0xe0,0xfd,0xff,0xfe,0xff,0x01,0x85,0x1f,0xfe,0xff,
0x07,0xff,0x00,0x00,0xe3,0xf8,0x00,0x00,0xff,0xfe,0xff,0x00,0x6a,0xfd,0xff,
0xfe,0xff,0x01,0xce,0x77,0xfe,0xff,0xfe,0xff,0x00,0xf1,0xfd,0xff,0xfe,0xff,
0x01,0xca,0x7f,0xfe,0xff,0x07,0xff,0x00,0x00,0xab,0x80,0x00,0x00,0xff,0xfe,
0xff,0x01,0x51,0x7f,0xfe,0xff,0xfe,0xff,0x00,0xe0,0xfd,0xff,0xf9,0xff,0xfe,
0xff,0x00,0xe1,0xfd,0xff,0x07,0xff,0xc0,0x00,0x1f,0x00,0x00,0x01,0xff,0xfe,
0xff,0x00,0xec,0xfd,0xff,0xfe,0xff,0x00,0xf3,0xfd,0xff,0xf9,0xff,0xf9,0xff,
0x07,0xff,0xc0,0x00,0xff,0xc0,0x00,0x03,0xff,0xf9,0xff,0xf9,0xff,0xf9,0xff,
};

#include "naglogo.h"

#if USE_KEYFILES

extern ULONG mdlogoCMap32[]; //TOFIX ??
extern struct BitMap mdlogoBitMap;
extern int foundoldkey;

#define NCREGTXTS 3
int	donag( int mode )
{
	APTR win;
	APTR bt_reg_cont, bt_reg_online, bt_reg, txt_info, txt_cnt;
	LONG id;
	ULONG msig = 0;
	int Done = FALSE;
	time_t last = timev();
	int ncregtxtcnt = 0;
	static STRPTR regtxt[ NCREGTXTS ];
	int days = ( last - getprefslong( DSI_NAG_FIRSTINSTALLTIME, last ) ) / ( 3600 * 24 ) + 1;
	int secslocked = ( days > 30 && mode && !foundoldkey ) ? days : 0;
	time_t secslast = 0;
	char *regurl, tmp[ 256 ];
	int rc = TRUE;

	if( foundoldkey )
		sprintf( tmp, "http://www.vapor.com/update/v_update.php3?amirc_ser=%lx", foundoldkey );
	else
		strcpy( tmp, "http://www.vapor.com/order/?oprod=voyager3" );

	regurl = strdup( tmp ); /* TOFIX */

	regtxt[ 0 ] = GS( REG_TXT1 );
	regtxt[ 1 ] = GS( REG_TXT2 );
	regtxt[ 2 ] = GS( REG_TXT3 );

	win = WindowObject,
		MUIA_Window_Title, "V³ Demo",
		MUIA_Window_LeftEdge, MUIV_Window_LeftEdge_Centered,
		MUIA_Window_TopEdge, MUIV_Window_TopEdge_Centered,
		MUIA_Window_CloseGadget, FALSE,
		MUIA_Window_NoMenus, TRUE,
		MUIA_Window_RootObject, HGroup,

			Child, VGroup, MUIA_Weight, 10000,

					Child, VSpace( 0 ),
					Child, BodychunkObject, GroupFrame, MUIA_Weight, 0, InnerSpacing( 0, 0 ),
							MUIA_Bodychunk_Body, reglogo_body,
							MUIA_Bodychunk_Compression, REGLOGO_COMPRESSION,
							MUIA_Bodychunk_Masking, REGLOGO_MASKING,
							MUIA_Bodychunk_Depth, REGLOGO_DEPTH,
							MUIA_Bitmap_Height, REGLOGO_HEIGHT, MUIA_Bitmap_Width, REGLOGO_WIDTH,
							MUIA_FixWidth, REGLOGO_WIDTH, MUIA_FixHeight, REGLOGO_HEIGHT,
							MUIA_Bitmap_SourceColors, reglogo_colors,
							MUIA_Bitmap_Precision, PRECISION_EXACT,
						End,
					Child, VSpace( 0 ),
				End,

				Child, MUI_MakeObject( MUIO_VBar, 0 ),

				Child, VGroup, MUIA_Weight, 10000,

					Child, VGroup, TextFrame, MUIA_Background, MUII_TextBack,

						Child, VSpace( 0 ),

						Child, TextObject, MUIA_Text_Contents, mode ? GS( REG_HEADER ) : GS( REG_OVER ),
						End,

						Child, txt_info = TextObject, MUIA_Text_Contents, regtxt[ 0 ], MUIA_Text_PreParse, "\033c", End,

						Child, txt_cnt = TextObject, End,

						Child, VSpace( 0 ),

					End,

					Child, bt_reg_cont = button( MSG_REGISTER_CONT, 0 ),
					Child, bt_reg_online = button( foundoldkey ? MSG_REGISTER_ONLINE_UPDATE : MSG_REGISTER_ONLINE, 0 ),
					Child, bt_reg = button( foundoldkey ? MSG_REGISTER_DO_UPDATE : MSG_REGISTER_DO, 0 ),

				End,
			End,
		End;

	DoMethod( txt_cnt, MUIM_SetAsString, MUIA_Text_Contents, GS( REG_CNT ),
		days,
		getprefslong( DSI_NAG_USECOUNT, 0 ),
		getprefslong( DSI_NAG_UPTIME, 0 ) / 60,
		getprefslong( DSI_NAG_UPTIME, 0 ) % 60
	);

	set( bt_reg_cont, MUIA_Disabled, secslocked );

	DoMethod( bt_reg_cont, MUIM_Notify, MUIA_Pressed, FALSE,
		app, 2, MUIM_Application_ReturnID, 30000
	);
	DoMethod( bt_reg_online, MUIM_Notify, MUIA_Pressed, FALSE,
		app, 2, MUIM_Application_ReturnID, 30001
	);
	DoMethod( bt_reg, MUIM_Notify, MUIA_Pressed, FALSE,
		app, 2, MUIM_Application_ReturnID, 30002
	);

	set( app, MUIA_Application_Sleep, TRUE );
	DoMethod( app, OM_ADDMEMBER, win );
	set( win, MUIA_Window_Open, TRUE );

	while( !Done )
	{
		if( timev() - last > 15 )
		{
			ncregtxtcnt = ( ncregtxtcnt + 1 ) % NCREGTXTS;
			set( txt_info, MUIA_Text_Contents, regtxt[ ncregtxtcnt ] );
			last = timev();
		}

		if( secslocked > 0 )
		{
			if( timev() - secslast > 0 )
			{
				secslocked--;
				if( secslocked )
				{
					DoMethod( bt_reg_cont, MUIM_SetAsString, MUIA_Text_Contents, "%s (%ld)", GS( REGISTER_CONT ), secslocked );
				}
				else
				{
					SetAttrs( bt_reg_cont, 
						MUIA_Text_Contents, GS( REGISTER_CONT ),
						MUIA_Disabled, FALSE,
						TAG_DONE
					);
				}
				secslast = timev();
			}
		}

		id = DoMethod( app, MUIM_Application_NewInput, &msig );

		switch( id )
		{
			case MUIV_Application_ReturnID_Quit:
			case 30000:
				Done = 1;
				if( !mode )
					DoMethod( app, MUIM_Application_ReturnID, -1 );
				break;

			case 30001:
				if( mode )
				{
					static char *ou[] = { NULL, NULL };
					extern char **openurls;
					ou[ 0 ] = regurl;
					openurls = ou;
				}
				else
				{
					DoMethod( app, MM_DoLastActiveWin, MM_HTMLWin_SetURL, regurl, NULL, NULL, MF_HTMLWin_AddURL | MF_HTMLWin_Reload );
				}
				Done = 1;
				break;

			case 30002:
				VAT_NewShowRegUtil( app, foundoldkey ? "UPGRADE Voyager 3" : "Voyager 3" );
				if( !mode )
					DoMethod( app, MUIM_Application_ReturnID, -1 );
				Done = 1;
				break;
		}

		if( msig && !Done )
			if( ( msig = Wait( msig | SIGBREAKF_CTRL_C ) ) & SIGBREAKF_CTRL_C )
			{
				rc = FALSE;
			}
	}

	set( win, MUIA_Window_Open, FALSE );
	DoMethod( app, OM_REMMEMBER, win );
	MUI_DisposeObject( win );
	set( app, MUIA_Application_Sleep, FALSE );

	return( rc );
}

#endif /* USE_KEYFILES */
